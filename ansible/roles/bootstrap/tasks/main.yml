---
# roles/bootstrap/tasks/main.yml
- name: Bootstrap first control-plane node
  ansible.builtin.command: >-
    kubeadm init
    --control-plane-endpoint {{ kube_vip_address }}:6443
    --upload-certs
    --pod-network-cidr={{ pod_cidr }}
    --service-cidr={{ service_cidr }}
    --kubernetes-version=v{{ k8s_version }}
    --skip-phases=addon/kube-proxy
  register: kubeadm_init
  when: is_bootstrap | bool
  changed_when: kubeadm_init.rc == 0
  failed_when: kubeadm_init.rc != 0 and 'already initialized' not in kubeadm_init.stderr

- name: Create .kube directory
  ansible.builtin.file:
    path: /home/{{ ansible_user }}/.kube
    state: directory
    owner: "{{ ansible_user }}"
    mode: '0700'
  when: is_bootstrap | bool

- name: Copy admin.conf to user
  ansible.builtin.copy:
    src: /etc/kubernetes/admin.conf
    dest: /home/{{ ansible_user }}/.kube/config
    remote_src: yes
    owner: "{{ ansible_user }}"
    mode: '0600'
  when: is_bootstrap | bool

- name: Generate worker join command
  ansible.builtin.command: kubeadm token create --print-join-command
  register: worker_join_raw
  when: is_bootstrap | bool

- name: Generate control-plane join command
  ansible.builtin.shell: |
    kubeadm token create --print-join-command --certificate-key $(kubeadm init phase upload-certs --upload-certs | tail -1)
  register: cp_join_raw
  when: is_bootstrap | bool

- name: Set join command facts (plain strings)
  ansible.builtin.set_fact:
    worker_join_cmd: "{{ worker_join_raw.stdout }}"
    cp_join_cmd: "{{ cp_join_raw.stdout }}"
  when: is_bootstrap | bool

- name: Export facts to all hosts (so other playbooks can use them)
  ansible.builtin.set_fact:
    join_worker_cmd: "{{ worker_join_cmd }}"
    join_controlplane_cmd: "{{ cp_join_cmd }}"
  delegate_to: "{{ item }}"
  delegate_facts: true
  loop: "{{ groups['all'] }}"
  when: is_bootstrap | bool

- name: Fetch admin.conf to your laptop (as kubeconfig)
  ansible.builtin.fetch:
    src: /etc/kubernetes/admin.conf
    dest: "kubeconfig-{{ inventory_hostname }}.yaml"
    flat: yes
  when: is_bootstrap | bool

# THIS IS THE ONLY LINE THAT CHANGED → become: false
- name: Save join scripts locally on your laptop (no sudo!)
  ansible.builtin.copy:
    content: "{{ item.content }}"
    dest: "{{ item.file }}"
  become: false               # ← THIS FIXES THE "sudo: a password is required" error
  delegate_to: localhost
  run_once: true
  when: is_bootstrap | bool
  loop:
    - { content: "{{ worker_join_cmd }}\n", file: "join-worker.sh" }
    - { content: "{{ cp_join_cmd }}\n",     file: "join-controlplane.sh" }