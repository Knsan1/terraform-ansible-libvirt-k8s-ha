---
- name: Full system upgrade
  apt:
    upgrade: dist
    update_cache: yes

- name: Disable swap
  command: swapoff -a

- name: Disable swap permanently
  replace:
    path: /etc/fstab
    regexp: '^([^#].*\sswap.*)'
    replace: '# \1'

- name: Load kernel modules
  modprobe:
    name: "{{ item }}"
  loop: [overlay, br_netfilter]

- name: Persist modules
  copy:
    content: "overlay\nbr_netfilter\n"
    dest: /etc/modules-load.d/k8s.conf

- name: Kubernetes sysctl (with ip_nonlocal_bind!)
  copy:
    content: |
      net.bridge.bridge-nf-call-iptables  = 1
      net.bridge.bridge-nf-call-ip6tables = 1
      net.ipv4.ip_forward                 = 1
      net.ipv4.ip_nonlocal_bind           = 1
    dest: /etc/sysctl.d/99-k8s.conf
  notify: reload sysctl